- type: env_optional
  data:
    INPUT_FILE: 
- type: read_cfg
  data:
    src: <<INPUT_FILE|dirname>>/resource/assets/cfgjson/s_skill.json
    store_key: s_skill
- type: read_cfg
  data:
    src: <<INPUT_FILE|dirname>>/resource/assets/cfgjson/s_buff_icon_show.json
    store_key: s_buff_icon_show
- type: read_cfg
  data:
    src: <<INPUT_FILE|dirname>>/resource/assets/cfgjson/s_buff_info.json
    store_key: s_buff_info
- type: read_cfg
  data:
    src: <<INPUT_FILE|dirname>>/resource/default.res.json
    store_key: default_res
- type: read_cfg
  data:
    src: <<INPUT_FILE>>
    store_key: battle_cfg
- type: eval
  data:
    code: |
      (() => {
        const BuffEType = {
          1: "BUFFâž•",
          2: "BUFFè§¦å‘",
          3: "BUFFâž–",
        };
        const SKILL_EVENT_TYPE = {
            1: "æŠ€èƒ½times å¼€å§‹",
            2: "æŠ€èƒ½times ç»“æŸ",
            3: "======æŠ€èƒ½é‡Šæ”¾ BEG======",
            4: "======æŠ€èƒ½é‡Šæ”¾ END======",
        };
        const ATK_RESULT = {
            1: "é—ªé¿",
            2: "å‘½ä¸­",
            3: "æš´å‡»",
            4: "å…ç–«æŠ€èƒ½",
            5: "å…‹åˆ¶",
            6: "åŠå…‹åˆ¶",
        };
        const GetAtkResultDesc = (result) => {
          const logs = [];
          for(let bitKey in ATK_RESULT) {
            const bit = +bitKey;
            if (result & (1 << bit)) {
              logs.push(ATK_RESULT[bit])
            }
          }
          return logs.join("+")
        };
        const GetValidString = (...str) => {
          return str.find((str) => str && str != "0")
        };
        const GetBuffName = (buffId) => {
          let buffTypeId = Math.floor(buffId / 1000);
          const buffInfo = this.s_buff_info.s_buff_info.find((buff) => buff[0] == buffTypeId);
          if (buffInfo) {
            buffTypeId = buffInfo[1];
          }
          const buffShow = this.s_buff_icon_show.s_buff_icon_show.find((buff) => buff[0] == buffTypeId);
          return buffShow ? `${GetValidString(buffShow[2], buffShow[4], buffId)} ${GetResPath(buffShow[1])}` : `${buffId}`;
        };
        const GetResPath = (resName) => {
          const resource = this.default_res.resources.find((res) => res.name == resName);
          if (!resource) return "";
          return `resource/${resource.url}`;
        };
        const GetSkillName = (skillId) => {
          return this.s_skill.s_skill.find((skill) => skill[0] == skillId)?.[1] || skillId;
        };
        const GetRoleName = (data, infoUnit) => {
          return `[${data._FID}] ${infoUnit.dicBattleCard[data._FID].name}`;
        };
        const GetTargetName = (data, infoUnit) => {
          return `[${data._targetFID}] ${infoUnit.dicBattleCard[data._targetFID].name}`;
        };
        this.EventTranslator = {
          1: (data, infoUnit) => {
            return `======ç¬¬ ${data.u8RoundNum} å›žåˆ======`;
          },
          2: (data, infoUnit) => {
            const title = `${GetRoleName(data, infoUnit)} å‡ºæ‰‹`;
            return title;
          },
          3: (data, infoUnit) => {
            const title = `${GetRoleName(data, infoUnit)} âš”ï¸ ${GetTargetName(data, infoUnit)}  ${GetSkillName(data.nSkillId)} ${GetAtkResultDesc(data.u8SkillRes)}`;
            return title;
          },
          4: (data, infoUnit) => {
            return `${GetRoleName(data, infoUnit)} ${BuffEType[data.eType]} ${GetBuffName(data.nBuffId)} (${GetSkillName(data.nSkillID)})`;
          },
          5: (data, infoUnit) => {
            const title = `${GetRoleName(data, infoUnit)} ðŸ©¸${data.I32ChgVal > 0 ? "+" : "-"}${Math.abs(data.I32ChgVal)} = ${data.u32Val}`;
            return title;
          },
          6: (data, infoUnit) => {
            const title = `å±žæ€§é­”é‡`;
            return title;
          },
          7: (data, infoUnit) => {
            const title = `ä½ç½®å˜æ›´, å¤‡æˆ˜çš„å‡ºç«™`;
            return title;
          },
          8: (data, infoUnit) => {
            const title = `ç”±å¤æ´»é€ æˆå±žæ€§è¡€é‡`;
            return title;
          },
          9: (data, infoUnit) => {
            const title = `æ´æŠ¤`;
            return title;
          },
          10: (data, infoUnit) => {
            const title = `åˆ†æ‹…é€ æˆçš„è¡€é‡å˜åŒ–;`;
            return title;
          },
          11: (data, infoUnit) => {
            const title = `æœ€å¤§è¡€é‡`;
            return title;
          },
          12: (data, infoUnit) => {
            const title = `æŠ¤ç›¾æ‰¿å—ä¼¤å®³æ•°å€¼`;
            return title;
          },
          13: (data, infoUnit) => {
            const title = `ä¼¤å®³åˆ†æ‘Š`;
            return title;
          },
          14: (data, infoUnit) => {
            const title = `å±žæ€§è¡€é‡(åŒå€ä¼¤å®³)`;
            return title;
          },
          15: (data, infoUnit) => {
            const title = `buffè®¡æ•°`;
            return title;
          },
          16: (data, infoUnit) => {
            const title = `æˆ˜åœºæŠ€èƒ½`;
            return title;
          },
          18: (data, infoUnit) => {
            const title = `${GetRoleName(data, infoUnit)} ${GetSkillName(data.nSkillId)} ${SKILL_EVENT_TYPE[data.u8SkillEvent]}`;
            return title;
          },
          19: (data, infoUnit) => {
            const title = `æ­»äº¡äº‹ä»¶`;
            return title;
          },
          20: (data, infoUnit) => {
            const title = `ä½ç½®å˜æ›´åŽä¿¡æ¯æ›´æ–°ç»“æŸæˆ˜æŠ¥`;
            return title;
          },
          21: (data, infoUnit) => {
            const title = `äºŒæ¬¡è¡ŒåŠ¨å¼€å§‹`;
            return title;
          },
          22: (data, infoUnit) => {
            const title = `æœ€å¤§å±žæ€§è“é‡å˜åŒ–`;
            return title;
          },
          23: (data, infoUnit) => {
            const title = `äº¤æ¢å‡ºæˆ˜é˜µä½`;
            return title;
          },
          24: (data, infoUnit) => {
            const title = `é€šçŸ¥å±•ç¤ºç‰¹æ®Šäº‹ä»¶çš„è¡¨çŽ°`;
            return title;
          },
          25: (data, infoUnit) => {
            const title = `é€šçŸ¥å±•ç¤ºç‰¹æ®Šäº‹ä»¶çš„è¡¨çŽ°`;
            return title;
          },
          26: (data, infoUnit) => {
            const title = `PERCastSkill begin end`;
            return title;
          },
          27: (data, infoUnit) => {
            const title = `è¿›å…¥å›žåˆæ—¶é€šçŸ¥äºŒåŠ¨èµ„æ ¼`;
            return title;
          },
          28: (data, infoUnit) => {
            const title = `${GetRoleName(data, infoUnit)} â›”ï¸ç»“æŸ`;
            return title;
          },
          29: (data, infoUnit) => {
            const title = `${GetRoleName(data, infoUnit)} buffå›žåˆ ${data.round} `;
            return title;
          },
          30: (data, infoUnit) => {
            const title = `å¬å”¤å•ä½`;
            return title;
          },
          31: (data, infoUnit) => {
            const title = `å›žåˆç»“æŸå¬å”¤ç‰©æ­»äº¡`;
            return title;
          },
          32: (data, infoUnit) => {
            const title = `å¬å”¤ç‰©è·Ÿéšæ­»äº¡`;
            return title;
          },
          33: (data, infoUnit) => {
            const title = `å¬å”¤ç‰©åˆ·æ–°æ­»äº¡`;
            return title;
          },
          34: (data, infoUnit) => {
            const title = `æŠ€èƒ½é€ æˆæ¶ˆè€—å±žæ€§é­”é‡`;
            return title;
          },
          35: (data, infoUnit) => {
            const title = `ä¸­æ¯’é€ æˆçš„è¡€é‡å˜åŒ–`;
            return title;
          },
          36: (data, infoUnit) => {
            const title = `æŒç»­ä¼¤å®³é€ æˆçš„è¡€é‡å˜åŒ–`;
            return title;
          },
          37: (data, infoUnit) => {
            const title = `é€ƒè·‘posåˆ—è¡¨`;
            return title;
          },
          38: (data, infoUnit) => {
            const title = `ä¸»åŠ¨æ¶ˆè€—è¡€é‡`;
            return title;
          },
          39: (data, infoUnit) => {
            const title = `é”è¡€`;
            return title;
          },
          40: (data, infoUnit) => {
            if (data.uFlagType == 0) {
              return `æŠ€èƒ½ç»“æŸï¼Œå¯ä»¥åŽç»­å±žæ€§åŠBUFFè¡¨çŽ°`;
            }
            const title = `==è¾…åŠ©å®¢æˆ·ç«¯çš„è¡¨çŽ°flag==`;
            return title;
          },
        };
      })()
- type: loop
  data:
    key: battle_cfg.infoUnits
    value_mapping: infoUnit
    commands:
      - type: eval
        data:
          code: |
            (() => {
              this.infoUnit.deqData.forEach(data => {
                  const formattor = this.EventTranslator[data.u8EventType] || ((data, infoUnit) => {
                    return `æœªçŸ¥ç±»åž‹:${data.u8EventType}`;
                  });
                  data.$ = formattor(data, this.infoUnit);
              });
            })()

- type: write_cfg
  data:
    key: battle_cfg
    type: json_compacted
    options:
      sort_keys:
        - $
    dst: <<INPUT_FILE>>
